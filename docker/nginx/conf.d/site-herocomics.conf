server {
  listen 80;
  server_name localhost;
  root /var/www/html;
  index index.php index.html;
  client_max_body_size 50m;

  add_header X-Nginx-Conf "site-herocomics:v2" always;

  # 내부 보호 경로 (다운로드 전용)
  location /_protected/ {
    internal;
    alias /var/www/html/uploads/;
  }

  # 업로드 경로 3개를 한 물리경로로 통일 (PHP 실행 금지)
  location ^~ /uploads/       { alias /var/www/html/uploads/;       add_header Cache-Control "public, max-age=604800, immutable"; }
  location ^~ /admin/uploads/ { alias /var/www/html/uploads/;       add_header Cache-Control "public, max-age=604800, immutable"; }
  location ^~ /web/uploads/   { alias /var/www/html/uploads/;       add_header Cache-Control "public, max-age=604800, immutable"; }
  location ~* ^/(uploads|admin/uploads|web/uploads)/.*\.php$ { return 404; }

  # /admin: alias + (중첩) PHP 처리
  location /admin/ {
    alias /var/www/html/web/admin/;
    index index.php index.html;
    try_files $uri $uri/ /admin/index.php?$args;

    # 이 블록이 일반 PHP 블록보다 먼저/우선
    location ~ \.php$ {
      include fastcgi_params;
      # alias(/var/www/html/web/admin)와 fastcgi_script_name(/admin/xxx.php)을 결합
      fastcgi_param SCRIPT_FILENAME /var/www/html/web$fastcgi_script_name;
      fastcgi_pass php:9000;
    }
  }

  # 루트 나머지
  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  # 일반 PHP
  location ~ \.php$ {
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    fastcgi_pass php:9000;
  }
}
